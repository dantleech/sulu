define(["config","sulusecurity/collections/roles"],function(a,b){"use strict";var c="/admin/api/permissions",d=a.get("sulusecurity.permissions").slice(0,-1),e=a.get("sulusecurity.permission_titles").slice(0,-1),f="#permission-loader",g="#matrix-container",h="#matrix",i={id:null,type:null,securityContext:null,permissions:{}},j=function(){this.sandbox.on("husky.matrix.changed",m.bind(this)),this.sandbox.on("sulu.permission-tab.save",o.bind(this))},k=function(){this.$el.html(this.renderTemplate("/admin/security/template/permission-tab/form")),this.sandbox.start([{name:"loader@husky",options:{el:this.$find(f),size:"100px",color:"#cccccc"}}])},l=function(){var a=this.sandbox.dom.createElement('<div id="matrix"/>');this.sandbox.dom.append(g,a);var j=new b;this.sandbox.data.when(j.fetch(),this.sandbox.util.ajax({url:[c,"?type=",i.type,"&id=",i.id].join("")})).done(function(a,b){j=j.toJSON();var c=b[0],g=[],k=[],l=[];this.sandbox.util.each(j,function(a,b){var e={},f=[];if(k.push(b.name),l.push(b.id),this.sandbox.util.each(d,function(a,b){e[b.value]=!1}.bind(this)),c.permissions.hasOwnProperty(b.id))this.sandbox.util.each(c.permissions[b.id],function(a,b){e[a]=b,f.push(b)});else{var h=q.call(this,this.options.securityContext,b);this.sandbox.util.each(h,function(a,b){e[a]=b,f.push(b)})}i.permissions[b.id]=e,g[a]=f}.bind(this)),this.sandbox.start([{name:"matrix@husky",options:{el:h,captions:{type:this.sandbox.translate("security.roles"),horizontal:this.sandbox.translate("security.roles.permissions"),all:this.sandbox.translate("security.roles.all"),none:this.sandbox.translate("security.roles.none"),vertical:k},values:{vertical:l,horizontal:d,titles:this.sandbox.translateArray(e)},data:g}}]),this.$find(f).hide()}.bind(this)),this.sandbox.emit("husky.permission-form.loaded")},m=function(a){"string"==typeof a.value?n.call(this,a.section,a.value,a.activated):this.sandbox.dom.each(a.value,function(b,c){n.call(this,a.section,c.value,a.activated)})},n=function(a,b,c){i.permissions[a][b]=c},o=function(a){this.sandbox.emit("sulu.permission-form.save",i,a)},p=function(){this.sandbox.on("husky.matrix.changed",function(){this.sandbox.emit("husky.permission-form.changed")}.bind(this))},q=function(a,b){var c=[];return this.sandbox.util.each(b.permissions,function(b,d){return d.context===a?(c=d.permissions,!1):void 0}),c};return{name:"Sulu Security Object Permission Tab",templates:["/admin/security/template/permission-tab/form"],layout:function(){return this.options.inOverlay?{extendExisting:!0}:{extendExisting:!0,content:{width:"fixed",leftSpace:!0,rightSpace:!0}}},initialize:function(){i.id=this.options.id,i.type=this.options.type,i.securityContext=this.options.securityContext,k.call(this),l.call(this),j.call(this),p.call(this)}}});